I"ƒ<h3 id="springä¹‹applicationlistener">Springä¹‹ApplicationListener</h3>

<h4 id="èƒŒæ™¯">èƒŒæ™¯</h4>

<p>springå†…ç½®çš„ä¸€ç§è§‚å¯Ÿè€…æ¨¡å¼å®ç°ã€‚æ¶‰åŠåˆ°çš„èº«ä»½æœ‰ä¸‰ç§ï¼šEventã€publisherã€Listenerã€‚å½“å‘å¸ƒè€…å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆlistenerä¼šè§‚å¯Ÿåˆ°è¿™ä¸ªäº‹ä»¶çš„å‘å¸ƒï¼Œå¹¶æ‰§è¡Œè‡ªå·±ç›¸åº”çš„é€»è¾‘ã€‚</p>

<p>åœ¨å®é™…çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæ˜¯ä¸€ç§éå¸¸å¥½çš„è§£è€¦æ–¹å¼ï¼Œæœ‰ç‚¹æ¶ˆæ¯çš„å‘³é“ã€‚æ¯”å¦‚æˆ‘ä»¬åº”ç”¨ä¸­å­˜åœ¨ä¸€ä¸ªâ€æ–°ç”¨æˆ·æ³¨å†Œå‘æ”¾ç§¯åˆ†â€œçš„éœ€æ±‚ï¼Œå¯ä»¥åšä¸€ä¸ªç”¨æˆ·æ³¨å†Œäº‹ä»¶ï¼Œå½“æ–°ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œå‘å¸ƒä¸€ä¸ªæ–°ç”¨æˆ·æ³¨å†Œäº‹ä»¶ï¼Œç”±ç›‘å¬å™¨å»åšç§¯åˆ†å‘æ”¾çš„é€»è¾‘ã€‚</p>

<h4 id="èº«ä»½æºç ç®€ä»‹">èº«ä»½æºç ç®€ä»‹</h4>

<p>å‰é¢æˆ‘ä»¬æœ‰èŠåˆ°ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸‰ç§èº«ä»½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹è¿™äº›èº«ä»½ä¸‹éƒ½æœ‰äº›ä»€ä¹ˆèƒ½åŠ›ï¼ˆæ–¹æ³•ï¼‰ã€‚</p>

<p>*Publisher</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ApplicationEventPublisher</span> <span class="o">{</span>

	<span class="cm">/**
	 * Notify all &lt;strong&gt;matching&lt;/strong&gt; listeners registered with this
	 * application of an application event. Events may be framework events
	 * (such as RequestHandledEvent) or application-specific events.
	 * @param event the event to publish
	 * @see org.springframework.web.context.support.RequestHandledEvent
	 */</span>
	<span class="kt">void</span> <span class="nf">publishEvent</span><span class="o">(</span><span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">);</span>

	<span class="cm">/**
	 * Notify all &lt;strong&gt;matching&lt;/strong&gt; listeners registered with this
	 * application of an event.
	 * &lt;p&gt;If the specified {@code event} is not an {@link ApplicationEvent},
	 * it is wrapped in a {@link PayloadApplicationEvent}.
	 * @param event the event to publish
	 * @since 4.2
	 * @see PayloadApplicationEvent
	 */</span>
	<span class="kt">void</span> <span class="nf">publishEvent</span><span class="o">(</span><span class="nc">Object</span> <span class="n">event</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></div></div>

<p>å‘å¸ƒè€…çš„èƒ½åŠ›éå¸¸ç²¾å‡†ï¼Œå°±æ˜¯å‘å¸ƒä¸€ä¸ªäº‹ä»¶ã€‚åŒæ—¶é‡è½½äº†ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å‘å¸ƒä¸€ä¸ªå¯¹è±¡ï¼Œä¸è¿‡åœ¨è¿‡ç¨‹ä¸­è¿™ä¸ªå¯¹è±¡ä¼šè¢«åŒ…è£…åˆ°PayloadApplicationEventå½“ä¸­</p>

<p>*Event</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ApplicationEvent</span> <span class="kd">extends</span> <span class="nc">EventObject</span> <span class="o">{</span>

	<span class="cm">/** use serialVersionUID from Spring 1.2 for interoperability */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">7099057708183571937L</span><span class="o">;</span>

	<span class="cm">/** System time when the event happened */</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">;</span>


	<span class="cm">/**
	 * Create a new ApplicationEvent.
	 * @param source the object on which the event initially occurred (never {@code null})
	 */</span>
	<span class="kd">public</span> <span class="nf">ApplicationEvent</span><span class="o">(</span><span class="nc">Object</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">timestamp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
	<span class="o">}</span>


	<span class="cm">/**
	 * Return the system time in milliseconds when the event happened.
	 */</span>
	<span class="kd">public</span> <span class="kd">final</span> <span class="kt">long</span> <span class="nf">getTimestamp</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">timestamp</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span>

<span class="o">----------------</span><span class="nc">EventObject</span><span class="o">---------------</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">EventObject</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">5516075349620653480L</span><span class="o">;</span>

    <span class="cm">/**
     * The object on which the Event initially occurred.
     */</span>
    <span class="kd">protected</span> <span class="kd">transient</span> <span class="nc">Object</span> <span class="n">source</span><span class="o">;</span>

    <span class="cm">/**
     * Constructs a prototypical Event.
     *
     * @param source the object on which the Event initially occurred
     * @throws IllegalArgumentException if source is null
     */</span>
    <span class="kd">public</span> <span class="nf">EventObject</span><span class="o">(</span><span class="nc">Object</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">source</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"null source"</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">;</span>
    <span class="o">}</span>
    
  <span class="o">}</span>
</code></pre></div></div>

<p>Eventå…¶å®ä¹Ÿéå¸¸ç®€å•ï¼Œä»–å°±æ˜¯åŒ…å«äº†ä¸€ä¸ªä¸å¯è¢«åºåˆ—åŒ–çš„Objectã€‚</p>

<p>*Listener</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="no">E</span> <span class="kd">extends</span> <span class="nc">ApplicationEvent</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">EventListener</span> <span class="o">{</span>

	<span class="cm">/**
	 * Handle an application event.
	 * @param event the event to respond to
	 */</span>
	<span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="no">E</span> <span class="n">event</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></div></div>

<p>EventListeneræ˜¯ä¸€ä¸ªæ ‡å¿—æ¥å£ï¼Œæ ‡å¿—æ¥å£ä¸€èˆ¬éƒ½æ˜¯æŸä¸€ç±»èº«ä»½çš„åˆ¤æ–­ï¼Œä¸å…·å¤‡ä»»ä½•å±æ€§å’Œæ–¹æ³•ã€‚åœ¨ç›‘å¬å™¨ä¸­ï¼Œåªæœ‰ä¸€ä¸ªonApplicationEventæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯æ—¶é—´å‘ç”Ÿæ—¶è¢«è°ƒç”¨çš„æœåŠ¡ã€‚åç»­æˆ‘ä»¬ä¼šåˆ†æä¸€æ•´å¥—çš„è°ƒç”¨é€»è¾‘ã€‚</p>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å¯¹ä»Šå¤©è¦èŠçš„æ—¶é—´å‘å¸ƒç›‘å¬æœ‰ä¸ªå¤§è‡´çš„äº†è§£ï¼Œå¯¹æ¯ä¸ªèº«ä»½æ˜¯ä»€ä¹ˆï¼Œåšä»€ä¹ˆä¹Ÿæœ‰äº†ä¸€å®šçš„äº†è§£ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·±å…¥springçš„æºç ï¼Œåˆ†æä¸€ä¸ªäº‹ä»¶å‘å¸ƒåˆ°ç›‘å¬æ‰§è¡Œåˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>

<h4 id="ä»¥contextrefreshedeventä¸ºä¾‹ä»‹ç»äº‹ä»¶å‘å¸ƒç›‘å¬">ä»¥ContextRefreshedEventä¸ºä¾‹ä»‹ç»äº‹ä»¶å‘å¸ƒç›‘å¬</h4>

<p>ContextRefreshedEventæ˜¯ApplicationEventçš„å…·ä½“å®ç°ï¼Œè¿™ä¸ªäº‹ä»¶è¡¨ç¤ºå½“ä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œspringä¸­å®¹å™¨æˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸ºContextï¼Œè¿™ä¸ªå®¹å™¨è¢«åˆå§‹åŒ–æˆ–è€…åˆ·æ–°æ—¶è§¦å‘ã€‚ä¸€ä¸‹æ˜¯å®ƒçš„æºç ï¼Œæ¯”è¾ƒç®€å•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContextRefreshedEvent</span> <span class="kd">extends</span> <span class="nc">ApplicationContextEvent</span> <span class="o">{</span>

	<span class="cm">/**
	 * Create a new ContextRefreshedEvent.
	 * @param source the {@code ApplicationContext} that has been initialized
	 * or refreshed (must not be {@code null})
	 */</span>
	<span class="kd">public</span> <span class="nf">ContextRefreshedEvent</span><span class="o">(</span><span class="nc">ApplicationContext</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å‰é¢ä»‹ç»äº†å¾ˆå¤šï¼Œæˆ‘ä»¬çŸ¥é“æ•´ä½“æµç¨‹çš„å…¥å£å°±åœ¨Publisherä¸­ï¼Œæˆ‘ä»¬å®šä½åˆ°ApplicationEventPublisherçš„éª¨æ¶å®ç°ï¼Œæˆ‘ä»¬å‘ç°å…¶å®æ˜¯é€šè¿‡Springå®¹å™¨Contextæ¥å®ç°çš„å‘å¸ƒæ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractApplicationContext</span> <span class="kd">extends</span> <span class="nc">DefaultResourceLoader</span>
		<span class="kd">implements</span> <span class="nc">ConfigurableApplicationContext</span><span class="o">,</span> <span class="nc">DisposableBean</span> <span class="o">{</span>
		
		<span class="c1">// äº‹ä»¶å‘å¸ƒ</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">publishEvent</span><span class="o">(</span><span class="nc">Object</span> <span class="n">event</span><span class="o">,</span> <span class="nc">ResolvableType</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Assert</span><span class="o">.</span><span class="na">notNull</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="s">"Event must not be null"</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isTraceEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="s">"Publishing event in "</span> <span class="o">+</span> <span class="n">getDisplayName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">event</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="c1">// Decorate event as an ApplicationEvent if necessary</span>
		<span class="c1">// è£…é¥°äº‹ä»¶</span>
		<span class="nc">ApplicationEvent</span> <span class="n">applicationEvent</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="k">instanceof</span> <span class="nc">ApplicationEvent</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">applicationEvent</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ApplicationEvent</span><span class="o">)</span> <span class="n">event</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
		<span class="c1">// å¦‚æœå‘å¸ƒçš„æ˜¯ä¸€ä¸ªObjectï¼Œé‚£ä¹ˆç”¨PayloadApplicationEventæ¥å°è£…å®ƒ</span>
			<span class="n">applicationEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PayloadApplicationEvent</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">eventType</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">eventType</span> <span class="o">=</span> <span class="o">((</span><span class="nc">PayloadApplicationEvent</span><span class="o">)</span> <span class="n">applicationEvent</span><span class="o">).</span><span class="na">getResolvableType</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="c1">// Multicast right now if possible - or lazily once the multicaster is initialized</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">earlyApplicationEvents</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">earlyApplicationEvents</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">applicationEvent</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
		<span class="c1">// è·å–æ—¶é—´å¤šæ’­å™¨ï¼Œå¹¶ä¸”å¹¿æ’­äº‹ä»¶</span>
			<span class="n">getApplicationEventMulticaster</span><span class="o">().</span><span class="na">multicastEvent</span><span class="o">(</span><span class="n">applicationEvent</span><span class="o">,</span> <span class="n">eventType</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="o">}</span>
</code></pre></div></div>

<p>ä¸Šé¢è¿™éƒ¨åˆ†ä»£ç æ ¸å¿ƒå°±æ˜¯â€è·å–æ—¶é—´å¤šæ’­å™¨ï¼Œå¹¶è¿›è¡Œå¹¿æ’­â€œã€‚æˆ‘ä»¬è¿›å…¥#getApplicationEventMulticaster()çš„è¯¦ç»†ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/**
	 * Return the internal ApplicationEventMulticaster used by the context.
	 * @return the internal ApplicationEventMulticaster (never {@code null})
	 * @throws IllegalStateException if the context has not been initialized yet
	 */</span>
	<span class="nc">ApplicationEventMulticaster</span> <span class="nf">getApplicationEventMulticaster</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IllegalStateException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">applicationEventMulticaster</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"ApplicationEventMulticaster not initialized - "</span> <span class="o">+</span>
					<span class="s">"call 'refresh' before multicasting events via the context: "</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationEventMulticaster</span><span class="o">;</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>applicationEventMulticasterè¿™ä¸ªä¸œè¥¿çš„åˆå§‹æ¢æ˜¯ä¼´éšç€å®¹å™¨åˆå§‹åŒ–å®Œæˆçš„ï¼Œå¹¶ä¸ºå®¹å™¨æ‰€ä½¿ç”¨ã€‚è·å–äº†ApplicationEventMuticasterï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è¿›è¡Œå¹¿æ’­äº†ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™ä¸ªæ¥å£æ‰€æ”¯æŒçš„æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ApplicationEventMulticaster</span> <span class="o">{</span>

	<span class="cm">/**
	 * Add a listener to be notified of all events.
	 * @param listener the listener to add
	 */</span>
	<span class="kt">void</span> <span class="nf">addApplicationListener</span><span class="o">(</span><span class="nc">ApplicationListener</span><span class="o">&lt;?&gt;</span> <span class="n">listener</span><span class="o">);</span>

	<span class="cm">/**
	 * Add a listener bean to be notified of all events.
	 * @param listenerBeanName the name of the listener bean to add
	 */</span>
	<span class="kt">void</span> <span class="nf">addApplicationListenerBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">listenerBeanName</span><span class="o">);</span>

	<span class="cm">/**
	 * Remove a listener from the notification list.
	 * @param listener the listener to remove
	 */</span>
	<span class="kt">void</span> <span class="nf">removeApplicationListener</span><span class="o">(</span><span class="nc">ApplicationListener</span><span class="o">&lt;?&gt;</span> <span class="n">listener</span><span class="o">);</span>

	<span class="cm">/**
	 * Remove a listener bean from the notification list.
	 * @param listenerBeanName the name of the listener bean to add
	 */</span>
	<span class="kt">void</span> <span class="nf">removeApplicationListenerBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">listenerBeanName</span><span class="o">);</span>

	<span class="cm">/**
	 * Remove all listeners registered with this multicaster.
	 * &lt;p&gt;After a remove call, the multicaster will perform no action
	 * on event notification until new listeners are being registered.
	 */</span>
	<span class="kt">void</span> <span class="nf">removeAllListeners</span><span class="o">();</span>

	<span class="cm">/**
	 * Multicast the given application event to appropriate listeners.
	 * &lt;p&gt;Consider using {@link #multicastEvent(ApplicationEvent, ResolvableType)}
	 * if possible as it provides a better support for generics-based events.
	 * @param event the event to multicast
	 */</span>
	<span class="kt">void</span> <span class="nf">multicastEvent</span><span class="o">(</span><span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">);</span>

	<span class="cm">/**
	 * Multicast the given application event to appropriate listeners.
	 * &lt;p&gt;If the {@code eventType} is {@code null}, a default type is built
	 * based on the {@code event} instance.
	 * @param event the event to multicast
	 * @param eventType the type of event (can be null)
	 * @since 4.2
	 */</span>
	<span class="kt">void</span> <span class="nf">multicastEvent</span><span class="o">(</span><span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">,</span> <span class="nc">ResolvableType</span> <span class="n">eventType</span><span class="o">);</span>

<span class="o">}</span>
</code></pre></div></div>

<p>ä»è¿™ä¸ªæ¥å£æ¥çœ‹ï¼Œæˆ‘ä»¬å¤§è‡´çŸ¥é“è¿™ä¸ªæ¥å£åŠŸèƒ½å¤§è‡´æ˜¯ï¼š</p>

<p>1ã€ç»´æŠ¤æ‰€æœ‰çš„ç›‘å¬å™¨Listener</p>

<p>2ã€å¹¿æ’­äº‹ä»¶åˆ°å¯¹åº”çš„ç›‘å¬å™¨</p>

<p>æ¥ä¸‹æ¥çœ‹å®ƒçš„multicastEventçš„å…·ä½“å®ç°</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">multicastEvent</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">,</span> <span class="nc">ResolvableType</span> <span class="n">eventType</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// ç±»å‹è½¬æ¢ç›¸å…³	</span>
  <span class="nc">ResolvableType</span> <span class="n">type</span> <span class="o">=</span> <span class="o">(</span><span class="n">eventType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">eventType</span> <span class="o">:</span> <span class="n">resolveDefaultEventType</span><span class="o">(</span><span class="n">event</span><span class="o">));</span>
  <span class="c1">// è·å–æ‰€æœ‰è¯¥äº‹ä»¶ç›¸å…³çš„æ‰€æœ‰ç›‘å¬å™¨</span>
		<span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">ApplicationListener</span><span class="o">&lt;?&gt;</span> <span class="n">listener</span> <span class="o">:</span> <span class="n">getApplicationListeners</span><span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">type</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// æ”¯æŒå¼‚æ­¥æ¶ˆæ¯æ¨é€</span>
			<span class="nc">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">getTaskExecutor</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
					<span class="nd">@Override</span>
					<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
						<span class="n">invokeListener</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">});</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
        <span class="c1">// åŒæ­¥æ¨é€</span>
				<span class="n">invokeListener</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>å¹¿æ’­äº‹ä»¶çš„æ—¶å€™ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>

<p>1ã€è·å–è¯¥äº‹ä»¶ç›¸å…³çš„ç›‘å¬å™¨</p>

<p>2ã€åˆ¤æ–­æ˜¯å¦éœ€è¦å¼‚æ­¥æ‰§è¡Œ</p>

<p>3ã€æŠŠäº‹ä»¶æ¨é€ç»™listenner</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹æœ€åä¸€æ­¥ï¼Œ#invokeListeneræ–¹æ³•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">invokeListener</span><span class="o">(</span><span class="nc">ApplicationListener</span><span class="o">&lt;?&gt;</span> <span class="n">listener</span><span class="o">,</span> <span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// æ˜¯å¦æœ‰é…ç½®é”™è¯¯å¤„ç†</span>
		<span class="nc">ErrorHandler</span> <span class="n">errorHandler</span> <span class="o">=</span> <span class="n">getErrorHandler</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">errorHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">doInvokeListener</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
			<span class="o">}</span>
			<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">err</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">errorHandler</span><span class="o">.</span><span class="na">handleError</span><span class="o">(</span><span class="n">err</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">doInvokeListener</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

<span class="o">----------</span><span class="err">#</span><span class="n">doInvokeListener</span><span class="o">----------</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doInvokeListener</span><span class="o">(</span><span class="nc">ApplicationListener</span> <span class="n">listener</span><span class="o">,</span> <span class="nc">ApplicationEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
      <span class="c1">// æ‰§è¡Œlistenerçš„onApplicationEventæ–¹æ³•</span>
			<span class="n">listener</span><span class="o">.</span><span class="na">onApplicationEvent</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">catch</span> <span class="o">(</span><span class="nc">ClassCastException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">matchesClassCastMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
				<span class="c1">// Possibly a lambda-defined listener which we could not resolve the generic event type for</span>
				<span class="c1">// -&gt; let's suppress the exception and just log a debug message.</span>
				<span class="nc">Log</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LogFactory</span><span class="o">.</span><span class="na">getLog</span><span class="o">(</span><span class="n">getClass</span><span class="o">());</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Non-matching event type for listener: "</span> <span class="o">+</span> <span class="n">listener</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ–¹æ³•éå¸¸ç®€å•ï¼š</p>

<p>1ã€åˆ¤æ–­æ˜¯å¦æœ‰å¼‚å¸¸å¤„ç†çš„Handlerï¼Œè¿™ä¸ªhandlerå¯ä»¥è‡ªå·±é…ç½®ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å¼‚æ­¥æƒ…å†µä¸‹çš„å¼‚å¸¸å¤„ç†</p>

<p>2ã€æ‰§è¡Œlistennerçš„onApplicationEventæ–¹æ³•</p>

<p>è‡³æ­¤ï¼Œæ•´å¥—äº‹ä»¶å‘å¸ƒç›‘å¬çš„é€»è¾‘å°±ç»“æŸäº†ã€‚ä¸‹é¢æ¼”ç¤ºä¸€ä¸‹å®æˆ˜ï¼š</p>

<p>æ¯ä¸€ä¸ªç”¨æˆ·æ³¨å†Œï¼Œæˆ‘ä»¬éœ€è¦ç»™ç”¨æˆ·å‘æ”¾100ä¼˜æƒ åˆ¸ï¼Œæˆ‘ä»¬é€šè¿‡äº‹ä»¶å‘å¸ƒç›‘å¬çš„æ–¹å¼å»å®ç°ï¼š</p>

<p>1ã€è®¾ç½®ä¸€ä¸ªç”¨æˆ·æ³¨å†Œäº‹ä»¶</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRegisterEvent</span> <span class="kd">extends</span> <span class="nc">ApplicationEvent</span> <span class="o">{</span>

    <span class="cm">/**
     * è¡¨ç¤ºä¸€ä¸ªç”¨æˆ·
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">;</span>
     <span class="kd">public</span> <span class="nf">UserRegisterEvent</span><span class="o">(</span><span class="nc">Object</span> <span class="n">source</span><span class="o">,</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
     * Create a new ApplicationEvent.
     *
     * @param source the object on which the event initially occurred (never {@code null})
     */</span>
    <span class="kd">public</span> <span class="nf">UserRegisterEvent</span><span class="o">(</span><span class="nc">Object</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUserId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUserId</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">userId</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2ã€è®¾ç½®ä¸€ä¸ªç›‘å¬å™¨</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// éœ€è¦æŠŠlisteneräº¤ç»™springå®¹å™¨è¿›è¡Œç®¡ç†</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRegisterListener</span> <span class="kd">implements</span> <span class="nc">ApplicationListener</span><span class="o">&lt;</span><span class="nc">UserRegisterEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**
     * Handle an application event.
     *
     * @param event the event to respond to
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">UserRegisterEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"user %s get 100 ticket"</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>3ã€äº‹ä»¶å‘å¸ƒï¼Œæˆ‘ä»¬ç”¨springçš„publisherå‘å¸ƒæ¶ˆæ¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="c1">// ä¸»åŠ¨å¯åŠ¨å®¹å™¨</span>
        <span class="nc">ClassPathXmlApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"META-INF/spring/dubbo-demo-provider.xml"</span><span class="o">});</span>
        <span class="n">context</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æœ‰ç”¨æˆ·æ³¨å†Œ"</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">publishEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserRegisterEvent</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">(),</span> <span class="s">"297988405"</span><span class="o">));</span>

    <span class="o">}</span>
</code></pre></div></div>

<p>4ã€è¿è¡Œç»“æœ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">æœ‰ç”¨æˆ·æ³¨å†Œ</span>
<span class="n">user</span> <span class="mi">297988405</span> <span class="n">get</span> <span class="mi">100</span> <span class="n">ticket</span>
</code></pre></div></div>

:ET